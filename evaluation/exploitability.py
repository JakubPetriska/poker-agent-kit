import itertools

import numpy as np

from response.best_response import BestResponse
from evaluation.game_value import GameValue


class Exploitability:
    """Calculates exploitability of strategy by computing best response,
    than computing the game value and than computing the exploitability
    for each player position by taking the difference between game value
    of the strategy and the best response.The returned exploitability is in mbb/g.
    """

    def __init__(self, game):
        self.game = game
        if game.get_num_players() != 2:
            raise AttributeError(
                'Only games with two players are supported')
        self.big_blind = None
        for i in range(game.get_num_players()):
            player_blind = game.get_blind(i)
            if self.big_blind == None or player_blind > self.big_blind:
                self.big_blind = player_blind
        self.best_response = BestResponse(game)
        self.game_value = GameValue(game)

    def evaluate(self, strategy):
        best_response = self.best_response.solve(strategy)
        game_values, positions = self.game_value.evaluate(strategy, best_response)
        player_game_values_mean = np.mean([game_values[i, positions[i, 1]] for i in range(len(game_values))])
        return player_game_values_mean * 1000 * self.big_blind
